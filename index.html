<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pak AstroAI – Climate & Pollution Tracker 🌍</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #020024, #090979, #00d4ff);
      color: white;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
    }
    header h1 {
      margin: 0;
      color: #00d4ff;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    input,
    button {
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      border: none;
    }
    button {
      background-color: #00d4ff;
      color: #000;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #00aaff;
    }
    .data-box {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    #forecast-container {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px;
    }
    .forecast-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 10px;
      min-width: 120px;
    }
    footer {
      margin-top: 40px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.5);
    }
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>

<body>
  <header>
    <h1>🌍 Pak AstroAI – Climate & Pollution Tracker</h1>
  </header>

  <div class="container">
    <h2>Check Weather and Air Quality of Your City</h2>
    <input type="text" id="cityInput" placeholder="Enter city (e.g. Lahore)" />
    <button onclick="searchCity()">Search</button>
    <button onclick="getLocation()">📍 Use My Location</button>

    <div id="weather-box" class="data-box">
      <h3>Weather</h3>
      <p id="weather-info">No data yet.</p>
    </div>

    <div id="air-box" class="data-box">
      <h3>Air Quality</h3>
      <p id="air-info">No data yet.</p>
    </div>

    <h3>7-Day Forecast</h3>
    <div id="forecast-container"></div>

    <h3>Ask AstroAI Chatbot 🤖</h3>
    <input type="text" id="chatInput" placeholder="Ask about AQI, pollution, or health..." />
    <button onclick="askBot()">Send</button>
    <p id="botResponse" style="margin-top: 10px"></p>
  </div>

  <footer>
    <p>
      Made by Team Pak AstroAI 🌍 | Data from
      <a href="https://openweathermap.org/" target="_blank" rel="noopener">OpenWeather</a> &
      <a href="https://www.iqair.com/" target="_blank" rel="noopener">AirVisual</a>
    </p>
  </footer>

  <script>
    // ⚙️ Update this with your server's local IP
    const BASE_URL = "http://192.168.100.18:5000";

    async function searchCity() {
      const city = document.getElementById("cityInput").value.trim();
      if (!city) return alert("Please enter a city name!");

      try {
        // 🌦 WEATHER DATA
        const weatherRes = await fetch(`${BASE_URL}/api/weather/${encodeURIComponent(city)}`);
        const weatherData = await weatherRes.json();

        if (!weatherRes.ok || weatherData.cod !== 200) {
          document.getElementById("weather-info").innerText = "City not found or invalid data!";
          return;
        }

        document.getElementById("weather-info").innerHTML = `
          🌆 City: ${weatherData.name}<br>
          🌡️ Temp: ${weatherData.main.temp}°C<br>
          ☁️ Condition: ${weatherData.weather[0].main}<br>
          💧 Humidity: ${weatherData.main.humidity}%<br>
          🌬️ Wind: ${weatherData.wind.speed} m/s
        `;

        // 🌫 AIR QUALITY
        const airRes = await fetch(`${BASE_URL}/api/air-quality/${encodeURIComponent(city)}`);
        const airData = await airRes.json();

        if (airData?.current?.pollution) {
          const p = airData.current.pollution;
          document.getElementById("air-info").innerHTML = `
            AQI (US): ${p.aqius}<br>
            PM2.5: ${p.mainus}<br>
            CO Level: ${p.aqicn || "N/A"}
          `;
        } else {
          document.getElementById("air-info").innerText = "Air quality data not available.";
        }

        // 📅 FORECAST DATA
        const forecastRes = await fetch(`${BASE_URL}/api/forecast/${encodeURIComponent(city)}`);
        const forecastData = await forecastRes.json();

        const container = document.getElementById("forecast-container");
        container.innerHTML = "";

        if (forecastData.list && forecastData.list.length > 0) {
          forecastData.list.slice(0, 7).forEach((item) => {
            const date = item.date || new Date(item.dt * 1000).toLocaleDateString();
            const div = document.createElement("div");
            div.className = "forecast-item";
            div.innerHTML = `
              <strong>${date}</strong><br>
              ${item.weather}<br>
              🌡️ Max: ${item.temp_max}°C<br>
              🌡️ Min: ${item.temp_min}°C
            `;
            container.appendChild(div);
          });
        } else {
          container.innerHTML = "<p>No forecast data available.</p>";
        }
      } catch (error) {
        console.error(error);
        alert("Something went wrong while fetching data!");
      }
    }

    async function getLocation() {
      if (!navigator.geolocation)
        return alert("Geolocation not supported in this browser.");
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        const res = await fetch(`${BASE_URL}/api/location`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat: latitude, lon: longitude }),
        });
        const data = await res.json();
        if (data?.weather) {
          document.getElementById("weather-info").innerHTML = `
            📍 Location: ${data.weather.name}<br>
            🌡️ Temp: ${data.weather.main.temp}°C<br>
            ☁️ Condition: ${data.weather.weather[0].main}
          `;
        }
      });
    }

    async function askBot() {
      const msg = document.getElementById("chatInput").value.trim();
      if (!msg) return alert("Please type a message!");

      try {
        const res = await fetch(`${BASE_URL}/api/chatbot`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg }),
        });
        const data = await res.json();
        document.getElementById("botResponse").innerText =
          data.response || "No reply from bot.";
      } catch {
        alert("Chatbot is currently unavailable.");
      }
    }
  </script>
</body>
</html>
